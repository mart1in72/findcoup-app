<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FindCoup </title>
    <style>
        /* === –°–¢–ò–õ–ò === */
        :root { --primary: #ff4757; --bg: #000000; --card: #1e272e; --text: #ffffff; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; height: 100vh; overflow: hidden; display: flex; justify-content: center; }
        .app { width: 100%; max-width: 480px; height: 100%; position: relative; display: flex; flex-direction: column; background: #111; }

        /* –≠–∫—Ä–∞–Ω—ã */
        .screen { display: none; flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px; }
        .screen.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity:0} to {opacity:1} }

        /* UI –≠–ª–µ–º–µ–Ω—Ç—ã */
        h2 { margin-top: 0; text-align: center; }
        input, textarea, select { width: 100%; padding: 14px; margin: 8px 0; background: #2f3542; border: none; border-radius: 12px; color: white; box-sizing: border-box; font-size: 16px; font-family: inherit; }
        textarea { resize: none; }
        button { width: 100%; padding: 14px; margin: 10px 0; background: var(--primary); border: none; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; font-size: 16px; }
        button.outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        button.sm { width: auto; padding: 8px 16px; margin: 0; font-size: 14px; }
        button.danger { background: transparent; border: 1px solid #ff4757; color: #ff4757; margin-top: 20px; }

        /* –ê–≤–∞—Ç–∞—Ä */
        .avatar-box { text-align: center; margin: 15px 0; }
        .avatar-preview { width: 110px; height: 110px; border-radius: 50%; object-fit: cover; border: 3px solid #333; display: inline-block; }
        .upload-label { color: var(--primary); display: block; margin-top: 5px; cursor: pointer; font-size: 14px; }

        /* –õ–µ–Ω—Ç–∞ */
        .feed-card { height: 65vh; background: var(--card); border-radius: 20px; overflow: hidden; position: relative; }
        .feed-card img { width: 100%; height: 100%; object-fit: cover; }
        .feed-info { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, black, transparent); padding: 20px; }

        /* –ú—ç—Ç—á–∏ */
        .matches-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .match-card { background: var(--card); border-radius: 15px; padding: 15px; text-align: center; display: flex; flex-direction: column; align-items: center; }
        .match-card img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 2px solid var(--primary); }
        .match-btn { background: var(--primary); border-radius: 20px; padding: 8px 20px; font-size: 13px; margin-top: auto; width: 100%; }

        /* –ß–∞—Ç—ã */
        .chat-row { display: flex; align-items: center; padding: 12px; background: var(--card); border-radius: 12px; margin-bottom: 8px; cursor: pointer; }
        .chat-row img { width: 50px; height: 50px; border-radius: 50%; margin-right: 12px; object-fit: cover; }
        .badge { background: var(--primary); color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 11px; margin-left: auto; }

        /* –ß–∞—Ç –æ–∫–Ω–æ */
        .full-chat { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 99; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s ease; }
        .full-chat.open { transform: translateX(0); }
        .chat-header { padding: 15px; background: var(--card); display: flex; align-items: center; border-bottom: 1px solid #333; }
        .chat-body { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 14px; border-radius: 18px; max-width: 80%; word-break: break-word; font-size: 15px; }
        .msg.me { background: var(--primary); align-self: flex-end; }
        .msg.him { background: #2f3542; align-self: flex-start; }
        .chat-footer { padding: 10px; background: var(--card); display: flex; gap: 10px; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav { position: absolute; bottom: 0; width: 100%; height: 60px; background: #151515; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #333; }
        .nav-btn { font-size: 22px; opacity: 0.5; cursor: pointer; }
        .nav-btn.active { opacity: 1; color: var(--primary); }
    </style>
</head>
<body>

<div class="app">
    <div id="scr-auth" class="screen active" style="text-align: center; padding-top: 40px;">
        <h1 style="color:var(--primary)">FindCoup</h1>
        <div id="auth-forms">
            <input type="text" id="l_u" placeholder="–õ–æ–≥–∏–Ω">
            <input type="password" id="l_p" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="login()">–í–æ–π—Ç–∏</button>
            <p onclick="toggleReg()" style="color:#777; cursor:pointer">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</p>
        </div>

        <div id="reg-forms" style="display:none">
            <div class="avatar-box">
                <img src="https://via.placeholder.com/100" id="r_img" class="avatar-preview">
                <label class="upload-label">
                    –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ <input type="file" style="display:none" onchange="upload(this, 'r_img')">
                </label>
            </div>
            <input type="text" id="r_u" placeholder="–õ–æ–≥–∏–Ω (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)">
            <input type="password" id="r_p" placeholder="–ü–∞—Ä–æ–ª—å">
            <input type="text" id="r_n" placeholder="–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è">
            <textarea id="r_bio" placeholder="–û —Å–µ–±–µ (–ø–∞—Ä—É —Å–ª–æ–≤)" rows="3"></textarea> <select id="r_g"><option value="–ü–∞—Ä–µ–Ω—å">–Ø –ü–∞—Ä–µ–Ω—å</option><option value="–î–µ–≤—É—à–∫–∞">–Ø –î–µ–≤—É—à–∫–∞</option></select>
            <button onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            <button class="outline" onclick="toggleReg()">–ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <div id="scr-feed" class="screen">
        <div id="feed-area">Loading...</div>
        <div style="display:flex; justify-content:space-evenly; margin-top:15px;">
            <button class="outline" style="width:45%" onclick="nextCard()">–°–∫–∏–ø</button>
            <button style="width:45%" onclick="doLike()">–õ–∞–π–∫</button>
        </div>
    </div>

    <div id="scr-matches" class="screen">
        <h2>–í–∞—à–∏ –ø–∞—Ä—ã</h2>
        <div id="matches-grid" class="matches-grid"></div>
    </div>

    <div id="scr-chats" class="screen">
        <h2>–°–æ–æ–±—â–µ–Ω–∏—è</h2>
        <div id="chats-list"></div>
    </div>

    <div id="scr-profile" class="screen">
        <div style="text-align:center; margin-top:20px;">
            <img id="p_img" class="avatar-preview" style="width:130px; height:130px;">
            <h2 id="p_name" style="margin-bottom: 5px;">Name</h2>
            <div id="p_bio" style="color: #aaa; margin: 10px 0; font-style: italic; white-space: pre-wrap;"></div>

            <button class="outline" onclick="openEdit()">‚úé –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
            <button class="danger" onclick="location.reload()">–í—ã–π—Ç–∏</button>
        </div>
    </div>

    <div id="scr-edit" class="screen">
        <h2>–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</h2>
        <div class="avatar-box">
            <img src="" id="e_img" class="avatar-preview">
            <label class="upload-label">
                –°–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ <input type="file" style="display:none" onchange="upload(this, 'e_img')">
            </label>
        </div>
        <label style="font-size:12px; color:#777; margin-left:5px;">–ò–º—è</label>
        <input type="text" id="e_n">
        <label style="font-size:12px; color:#777; margin-left:5px;">–û —Å–µ–±–µ</label>
        <textarea id="e_bio" rows="4"></textarea>

        <button onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        <button class="outline" onclick="go('scr-profile')">–û—Ç–º–µ–Ω–∞</button>
    </div>

    <div id="chat-win" class="full-chat">
        <div class="chat-header">
            <button class="sm outline" onclick="closeChat()">–ù–∞–∑–∞–¥</button>
            <b id="c_title" style="margin-left:15px">User</b>
        </div>
        <div id="c_box" class="chat-body"></div>
        <div class="chat-footer">
            <input id="c_in" type="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0">
            <button class="sm" style="margin:0" onclick="sendMsg()">‚û§</button>
        </div>
    </div>

    <div id="nav" class="nav" style="display:none">
        <div class="nav-btn active" onclick="go('scr-feed', this)">üè†</div>
        <div class="nav-btn" onclick="go('scr-matches', this)">‚ù§Ô∏è</div>
        <div class="nav-btn" onclick="go('scr-chats', this)">üí¨</div>
        <div class="nav-btn" onclick="go('scr-profile', this)">üë§</div>
    </div>
</div>

<script>
    const API = "";

    let ME = null;
    let FEED = [];
    let CURR = null;
    let CHAT_USER = null;
    // –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è URL –∞–≤–∞—Ç–∞—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    let TEMP_AVATAR = "https://via.placeholder.com/150";
    let EDIT_AVATAR_URL = "";
    let POLLING = false;

    // --- NAV ---
    function go(id, btn) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –≤–µ–∑–¥–µ –∫—Ä–æ–º–µ –≤—Ö–æ–¥–∞ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        const showNav = ['scr-feed', 'scr-matches', 'scr-chats', 'scr-profile'].includes(id);
        document.getElementById('nav').style.display = showNav ? 'flex' : 'none';

        if(btn) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        if(id === 'scr-feed') loadFeed();
        if(id === 'scr-matches') loadMatches();
        if(id === 'scr-chats') loadChats();
        if(id === 'scr-profile') renderProfile();
    }

    function toggleReg() {
        const r = document.getElementById('reg-forms');
        const l = document.getElementById('auth-forms');
        if(r.style.display === 'none') { r.style.display='block'; l.style.display='none'; }
        else { r.style.display='none'; l.style.display='block'; }
    }

    // --- API ---
    async function req(ep, method="GET", data=null) {
        try {
            const opts = { method, headers: {'Content-Type': 'application/json'} };
            if(data) opts.body = JSON.stringify(data);
            const r = await fetch(ep, opts);
            if(!r.ok) throw new Error("Err");
            return await r.json();
        } catch(e) { console.error(e); return null; }
    }

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ (–¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
    async function upload(inp, imgId) {
        const fd = new FormData();
        fd.append("file", inp.files[0]);
        // –ü—Ä–µ–≤—å—é —Å—Ä–∞–∑—É
        const reader = new FileReader();
        reader.onload = e => document.getElementById(imgId).src = e.target.result;
        reader.readAsDataURL(inp.files[0]);

        const r = await fetch("/upload", {method:"POST", body:fd});
        if(r.ok) {
            const d = await r.json();
            // –ï—Å–ª–∏ —ç—Ç–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
            if(imgId === 'r_img') TEMP_AVATAR = d.url;
            // –ï—Å–ª–∏ —ç—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            if(imgId === 'e_img') EDIT_AVATAR_URL = d.url;
        }
    }

    // --- AUTH ---
    async function login() {
        const u = document.getElementById('l_u').value;
        const p = document.getElementById('l_p').value;
        const res = await req(`/login`, "POST", {username:u, password:p});
        if(res) { ME = res; go('scr-feed'); }
        else alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞");
    }

    async function register() {
        const u = document.getElementById('r_u').value;
        const p = document.getElementById('r_p').value;
        const n = document.getElementById('r_n').value;
        const b = document.getElementById('r_bio').value; // –û–ø–∏—Å–∞–Ω–∏–µ
        const g = document.getElementById('r_g').value;

        const res = await req(`/register`, "POST", {
            username:u, password:p, first_name:n, gender:g, bio:b, avatar_url:TEMP_AVATAR
        });
        if(res) { ME = res; go('scr-feed'); }
        else alert("–û—à–∏–±–∫–∞. –í–æ–∑–º–æ–∂–Ω–æ –ª–æ–≥–∏–Ω –∑–∞–Ω—è—Ç.");
    }

    // --- –ü–†–û–§–ò–õ–¨ –ò –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï ---
    function renderProfile() {
        document.getElementById('p_img').src = ME.avatar_url;
        document.getElementById('p_name').innerText = ME.first_name;
        document.getElementById('p_bio').innerText = ME.bio || "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è";
    }

    function openEdit() {
        document.getElementById('e_n').value = ME.first_name;
        document.getElementById('e_bio').value = ME.bio || "";
        document.getElementById('e_img').src = ME.avatar_url;
        EDIT_AVATAR_URL = ME.avatar_url; // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Ä–∞–≤–Ω–∞ —Ç–µ–∫—É—â–µ–π
        go('scr-edit');
    }

    async function saveProfile() {
        const newName = document.getElementById('e_n').value;
        const newBio = document.getElementById('e_bio').value;

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        const res = await req("/update_profile", "PATCH", {
            username: ME.username, // –õ–æ–≥–∏–Ω –Ω—É–∂–µ–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞
            first_name: newName,
            bio: newBio,
            avatar_url: EDIT_AVATAR_URL
        });

        if(res) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            ME.first_name = res.first_name;
            ME.bio = res.bio;
            ME.avatar_url = res.avatar_url;
            go('scr-profile'); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª—å
        } else {
            alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
        }
    }

    // --- FEED ---
    async function loadFeed() {
        if(FEED.length) return;
        const res = await req(`/feed?gender=${ME.gender}&my_username=${ME.username}`);
        FEED = res || [];
        nextCard();
    }
    function nextCard() {
        const area = document.getElementById('feed-area');
        if(!FEED.length) { area.innerHTML = "<br><center>–ü—É—Å—Ç–æ...</center>"; CURR=null; return; }
        CURR = FEED.pop();
        area.innerHTML = `
            <div class="feed-card">
                <img src="${CURR.avatar_url}">
                <div class="feed-info">
                    <h2 style="margin-bottom:5px">${CURR.first_name}, @${CURR.username}</h2>
                    <p style="margin:0; opacity:0.8">${CURR.bio || ""}</p>
                </div>
            </div>`;
    }
    async function doLike() {
        if(!CURR) return;
        await req("/like", "POST", {from_email: ME.email, to_email: CURR.email});
        nextCard();
    }

    // --- CHATS & MATCHES ---
    async function loadMatches() {
        const list = await req(`/matches?email=${ME.email}`) || [];
        const grid = document.getElementById('matches-grid');
        grid.innerHTML = "";
        if(!list.length) grid.innerHTML = "<p>–ù–µ—Ç –ø–∞—Ä</p>";
        list.forEach(u => {
            const div = document.createElement('div');
            div.className = 'match-card';
            div.innerHTML = `<img src="${u.avatar_url}"><b>${u.first_name}</b><button class="match-btn" onclick='openChat(${JSON.stringify(u)})'>–ù–∞–ø–∏—Å–∞—Ç—å</button>`;
            grid.appendChild(div);
        });
    }

    async function loadChats() {
        const list = await req(`/chats_list?email=${ME.email}`) || [];
        const cont = document.getElementById('chats-list');
        cont.innerHTML = "";
        list.forEach(u => {
            const b = u.unread_count > 0 ? `<div class="badge">${u.unread_count}</div>` : "";
            const div = document.createElement('div');
            div.className = 'chat-row';
            div.innerHTML = `<img src="${u.avatar_url}"> <div><b>${u.first_name}</b></div> ${b}`;
            div.onclick = () => openChat(u);
            cont.appendChild(div);
        });
    }

    // --- MESSAGING ---
    function openChat(user) {
        CHAT_USER = user;
        document.getElementById('c_title').innerText = user.first_name;
        document.getElementById('chat-win').classList.add('open');
        POLLING = true;
        pollChat();
    }

    function closeChat() {
        document.getElementById('chat-win').classList.remove('open');
        POLLING = false;
        CHAT_USER = null;
        go('scr-chats');
    }

    async function pollChat() {
        if(!POLLING || !CHAT_USER) return;
        const msgs = await req(`/chat?u1=${ME.email}&u2=${CHAT_USER.email}`);
        const box = document.getElementById('c_box');
        if(msgs && box.childElementCount !== msgs.length) {
            box.innerHTML = msgs.map(m => `<div class="msg ${m.sender_email === ME.email ? 'me' : 'him'}">${m.text}</div>`).join('');
            box.scrollTop = box.scrollHeight;
        }
        setTimeout(pollChat, 2000);
    }

    async function sendMsg() {
        const inp = document.getElementById('c_in');
        const txt = inp.value.trim();
        if(!txt) return;
        inp.value = "";
        document.getElementById('c_box').innerHTML += `<div class="msg me">${txt}</div>`;
        document.getElementById('c_box').scrollTop = 99999;
        await req("/message", "POST", {sender_email:ME.email, receiver_email:CHAT_USER.email, text:txt});
    }
</script>
</body>
</html>
