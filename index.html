<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FindCoup v6.0 (Admin)</title>
    <style>
        /* === –°–¢–ò–õ–ò === */
        :root { --primary: #ff4757; --bg: #000000; --card: #1e272e; --text: #ffffff; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; height: 100vh; overflow: hidden; display: flex; justify-content: center; }
        .app { width: 100%; max-width: 480px; height: 100%; position: relative; display: flex; flex-direction: column; background: #111; }

        .screen { display: none; flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px; }
        .screen.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity:0} to {opacity:1} }

        h2 { margin-top: 0; text-align: center; }
        input, textarea, select { width: 100%; padding: 14px; margin: 8px 0; background: #2f3542; border: none; border-radius: 12px; color: white; box-sizing: border-box; font-size: 16px; font-family: inherit; }
        textarea { resize: none; }
        button { width: 100%; padding: 14px; margin: 10px 0; background: var(--primary); border: none; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; font-size: 16px; }
        button.outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        button.sm { width: auto; padding: 8px 16px; margin: 0; font-size: 14px; }
        button.danger { background: transparent; border: 1px solid #ff4757; color: #ff4757; margin-top: 20px; }

        .error-msg { color: #ff4757; text-align: center; font-size: 14px; margin-bottom: 10px; min-height: 20px; }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ */
        .admin-row { background: var(--card); padding: 15px; border-radius: 15px; margin-bottom: 15px; display: flex; align-items: center; gap: 15px; }
        .admin-row img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; }
        .admin-info { flex: 1; }
        .admin-actions { display: flex; gap: 10px; flex-direction: column; }
        .btn-approve { background: #2ed573; padding: 8px; margin: 0; width: 40px; }
        .btn-reject { background: #ff4757; padding: 8px; margin: 0; width: 40px; }

        /* ...–æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –∏–∑ –ø—Ä–æ—à–ª—ã—Ö –≤–µ—Ä—Å–∏–π... */
        .avatar-box { text-align: center; margin: 15px 0; }
        .avatar-preview { width: 110px; height: 110px; border-radius: 50%; object-fit: cover; border: 3px solid #333; display: inline-block; }
        .upload-label { color: var(--primary); display: block; margin-top: 5px; cursor: pointer; font-size: 14px; }
        .feed-card { height: 65vh; background: var(--card); border-radius: 20px; overflow: hidden; position: relative; }
        .feed-card img { width: 100%; height: 100%; object-fit: cover; }
        .feed-info { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, black, transparent); padding: 20px; }
        .matches-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .match-card { background: var(--card); border-radius: 15px; padding: 15px; text-align: center; display: flex; flex-direction: column; align-items: center; }
        .match-card img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 2px solid var(--primary); }
        .match-btn { background: var(--primary); border-radius: 20px; padding: 8px 20px; font-size: 13px; margin-top: auto; width: 100%; }
        .chat-row { display: flex; align-items: center; padding: 12px; background: var(--card); border-radius: 12px; margin-bottom: 8px; cursor: pointer; }
        .chat-row img { width: 50px; height: 50px; border-radius: 50%; margin-right: 12px; object-fit: cover; }
        .badge { background: var(--primary); color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 11px; margin-left: auto; }
        .full-chat { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 99; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s ease; }
        .full-chat.open { transform: translateX(0); }
        .chat-header { padding: 15px; background: var(--card); display: flex; align-items: center; border-bottom: 1px solid #333; }
        .chat-body { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 14px; border-radius: 18px; max-width: 80%; word-break: break-word; font-size: 15px; }
        .msg.me { background: var(--primary); align-self: flex-end; }
        .msg.him { background: #2f3542; align-self: flex-start; }
        .chat-footer { padding: 10px; background: var(--card); display: flex; gap: 10px; }
        .nav { position: absolute; bottom: 0; width: 100%; height: 60px; background: #151515; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #333; }
        .nav-btn { font-size: 22px; opacity: 0.5; cursor: pointer; position: relative; }
        .nav-btn.active { opacity: 1; color: var(--primary); }
        .nav-badge { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid #151515; display: none; }
    </style>
</head>
<body>

<div class="app">
    <div id="scr-auth" class="screen active" style="text-align: center; padding-top: 40px;">
        <h1 style="color:var(--primary)">FindCoup</h1>
        <div id="auth-forms">
            <input type="text" id="l_u" placeholder="–õ–æ–≥–∏–Ω">
            <input type="password" id="l_p" placeholder="–ü–∞—Ä–æ–ª—å">
            <div id="login-err" class="error-msg"></div>
            <button onclick="login()">–í–æ–π—Ç–∏</button>
            <p onclick="toggleReg()" style="color:#777; cursor:pointer; font-size:14px;">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</p>
            <p onclick="toggleReset()" style="color:#777; cursor:pointer; font-size:14px;">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</p>
        </div>

        <div id="reg-forms" style="display:none">
            <div class="avatar-box">
                <img src="https://via.placeholder.com/100" id="r_img" class="avatar-preview">
                <label class="upload-label">
                    –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ <input type="file" style="display:none" onchange="upload(this, 'r_img')">
                </label>
            </div>
            <input type="text" id="r_u" placeholder="–õ–æ–≥–∏–Ω">
            <input type="password" id="r_p" placeholder="–ü–∞—Ä–æ–ª—å">
            <input type="text" id="r_n" placeholder="–ò–º—è">
            <input type="text" id="r_key" placeholder="–°–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–ª–æ–≤–æ">
            <textarea id="r_bio" placeholder="–û —Å–µ–±–µ" rows="2"></textarea>
            <select id="r_g"><option value="–ü–∞—Ä–µ–Ω—å">–Ø –ü–∞—Ä–µ–Ω—å</option><option value="–î–µ–≤—É—à–∫–∞">–Ø –î–µ–≤—É—à–∫–∞</option></select>
            <div id="reg-err" class="error-msg"></div>
            <button onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            <button class="outline" onclick="toggleReg()">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="reset-forms" style="display:none">
            <h3>–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è</h3>
            <input type="text" id="res_u" placeholder="–õ–æ–≥–∏–Ω">
            <input type="text" id="res_key" placeholder="–°–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–ª–æ–≤–æ">
            <input type="password" id="res_new_p" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
            <div id="reset-err" class="error-msg"></div>
            <button onclick="doReset()">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
            <button class="outline" onclick="toggleReset()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div id="scr-admin" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>–ó–∞—è–≤–∫–∏ (<span id="adm-count">0</span>)</h2>
            <button class="sm danger" onclick="location.reload()">–í—ã—Ö–æ–¥</button>
        </div>
        <p style="font-size:12px; color:#777; text-align:center;">–û–¥–æ–±—Ä—è–π—Ç–µ —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã—Ö –ª—é–¥–µ–π</p>
        <div id="admin-list"></div>
    </div>

    <div id="scr-feed" class="screen">
        <div id="feed-area">Loading...</div>
        <div style="display:flex; justify-content:space-evenly; margin-top:15px;">
            <button class="outline" style="width:45%" onclick="nextCard()">–î–∞–ª—å—à–µ</button>
            <button style="width:45%" onclick="doLike()">–õ–∞–π–∫</button>
        </div>
    </div>

    <div id="scr-matches" class="screen">
        <h2>–í–∞—à–∏ –ø–∞—Ä—ã</h2>
        <div id="matches-grid" class="matches-grid"></div>
    </div>

    <div id="scr-chats" class="screen">
        <h2>–°–æ–æ–±—â–µ–Ω–∏—è</h2>
        <div id="chats-list"></div>
    </div>

    <div id="scr-profile" class="screen">
        <div style="text-align:center; margin-top:20px;">
            <img id="p_img" class="avatar-preview" style="width:130px; height:130px;">
            <h2 id="p_name" style="margin-bottom: 5px;">Name</h2>
            <div id="p_bio" style="color: #aaa; margin: 10px 0; font-style: italic; white-space: pre-wrap;"></div>
            <button class="outline" onclick="requestNotifPermission()">üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
            <button class="outline" onclick="openEdit()">‚úé –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
            <button class="danger" onclick="location.reload()">–í—ã–π—Ç–∏</button>
        </div>
    </div>

    <div id="scr-edit" class="screen">
        <h2>–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</h2>
        <div class="avatar-box">
            <img src="" id="e_img" class="avatar-preview">
            <label class="upload-label">–°–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ <input type="file" style="display:none" onchange="upload(this, 'e_img')"></label>
        </div>
        <input type="text" id="e_n">
        <textarea id="e_bio" rows="4"></textarea>
        <button onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        <button class="outline" onclick="go('scr-profile')">–û—Ç–º–µ–Ω–∞</button>
    </div>

    <div id="chat-win" class="full-chat">
        <div class="chat-header">
            <button class="sm outline" onclick="closeChat()">–ù–∞–∑–∞–¥</button>
            <b id="c_title" style="margin-left:15px">User</b>
        </div>
        <div id="c_box" class="chat-body"></div>
        <div class="chat-footer">
            <input id="c_in" type="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0">
            <button class="sm" style="margin:0" onclick="sendMsg()">‚û§</button>
        </div>
    </div>

    <div id="nav" class="nav" style="display:none">
        <div class="nav-btn active" onclick="go('scr-feed', this)">üè†</div>
        <div class="nav-btn" onclick="go('scr-matches', this)">‚ù§Ô∏è</div>
        <div class="nav-btn" onclick="go('scr-chats', this)">
            üí¨ <div id="nav-msg-badge" class="nav-badge">0</div>
        </div>
        <div class="nav-btn" onclick="go('scr-profile', this)">üë§</div>
    </div>
</div>

<script>
    const API = "";
    let ME = null;
    let FEED = []; let CURR = null; let CHAT_USER = null;
    let TEMP_AVATAR = "https://via.placeholder.com/150";
    let EDIT_AVATAR_URL = "";
    let UNREAD_INTERVAL = null; let LAST_NOTIF_ID = null;
    let POLLING = false;

    // --- NAV ---
    function go(id, btn) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');

        // –ü–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ —Å–∫—Ä—ã—Ç–∞ –¥–ª—è –∞–¥–º–∏–Ω–∞ –∏ Auth
        const showNav = ['scr-feed', 'scr-matches', 'scr-chats', 'scr-profile'].includes(id);
        document.getElementById('nav').style.display = showNav ? 'flex' : 'none';

        if(btn) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        if(id === 'scr-feed') loadFeed();
        if(id === 'scr-matches') loadMatches();
        if(id === 'scr-chats') loadChats();
        if(id === 'scr-profile') renderProfile();
        if(id === 'scr-admin') loadAdminList(); // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∞–¥–º–∏–Ω–∫–∏
    }

    // --- AUTH UI ---
    function toggleReg() { hideAllAuth(); document.getElementById('reg-forms').style.display = 'block'; }
    function toggleReset() { hideAllAuth(); document.getElementById('reset-forms').style.display = 'block'; }
    function hideAllAuth() {
        document.getElementById('auth-forms').style.display = 'none';
        document.getElementById('reg-forms').style.display = 'none';
        document.getElementById('reset-forms').style.display = 'none';
        document.querySelectorAll('.error-msg').forEach(e => e.innerText = '');
    }
    document.querySelectorAll('.outline').forEach(b => {
        if(b.innerText === '–ù–∞–∑–∞–¥' || b.innerText === '–û—Ç–º–µ–Ω–∞') {
           b.onclick = () => { hideAllAuth(); document.getElementById('auth-forms').style.display = 'block'; };
        }
    });

    // --- API ---
    async function req(ep, method="GET", data=null) {
        try {
            const opts = { method, headers: {'Content-Type': 'application/json'} };
            if(data) opts.body = JSON.stringify(data);
            const r = await fetch(ep, opts);
            const json = await r.json();
            if(!r.ok) throw new Error(json.detail || "–û—à–∏–±–∫–∞");
            return json;
        } catch(e) { return { error: true, msg: e.message }; }
    }
    async function upload(inp, imgId) {
        const fd = new FormData();
        fd.append("file", inp.files[0]);
        const reader = new FileReader();
        reader.onload = e => document.getElementById(imgId).src = e.target.result;
        reader.readAsDataURL(inp.files[0]);
        const r = await fetch("/upload", {method:"POST", body:fd});
        if(r.ok) {
            const d = await r.json();
            if(imgId === 'r_img') TEMP_AVATAR = d.url;
            if(imgId === 'e_img') EDIT_AVATAR_URL = d.url;
        }
    }

    // --- LOGIC ---
    async function login() {
        const u = document.getElementById('l_u').value;
        const p = document.getElementById('l_p').value;
        const res = await req(`/login`, "POST", {username:u, password:p});

        if(res.error) {
            document.getElementById('login-err').innerText = res.msg;
        } else {
            ME = res;
            if (ME.username === "admin") {
                // –ï—Å–ª–∏ –∞–¥–º–∏–Ω - –∏–¥–µ–º –≤ –∞–¥–º–∏–Ω–∫—É
                go('scr-admin');
            } else {
                // –ï—Å–ª–∏ —é–∑–µ—Ä - –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                requestNotifPermission();
                startUnreadPoller();
                go('scr-feed');
            }
        }
    }

    async function register() {
        const u = document.getElementById('r_u').value;
        const p = document.getElementById('r_p').value;
        const n = document.getElementById('r_n').value;
        const b = document.getElementById('r_bio').value;
        const k = document.getElementById('r_key').value;
        const g = document.getElementById('r_g').value;

        const res = await req(`/register`, "POST", {
            username:u, password:p, first_name:n, gender:g, bio:b, avatar_url:TEMP_AVATAR, secret_key: k
        });

        if(res.error) {
            document.getElementById('reg-err').innerText = res.msg;
        } else {
            // –ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å—Ä–∞–∑—É –≥–æ–≤–æ—Ä–∏–º –∂–¥–∞—Ç—å –æ–¥–æ–±—Ä–µ–Ω–∏—è
            alert("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –¥–æ–∂–¥–∏—Ç–µ—Å—å –æ–¥–æ–±—Ä–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.");
            hideAllAuth();
            document.getElementById('auth-forms').style.display = 'block';
        }
    }

    async function doReset() {
        const u = document.getElementById('res_u').value;
        const k = document.getElementById('res_key').value;
        const np = document.getElementById('res_new_p').value;
        const res = await req("/reset_password", "POST", {username:u, secret_key:k, new_password:np});
        if(res.error) document.getElementById('reset-err').innerText = res.msg;
        else { alert("–ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω!"); hideAllAuth(); document.getElementById('auth-forms').style.display = 'block'; }
    }

    // --- ADMIN FUNCTIONS ---
    async function loadAdminList() {
        const list = await req("/admin/pending");
        const cont = document.getElementById('admin-list');
        cont.innerHTML = "";

        if (!list || list.length === 0) {
            cont.innerHTML = "<p style='text-align:center; color:#555'>–ó–∞—è–≤–æ–∫ –Ω–µ—Ç</p>";
            document.getElementById('adm-count').innerText = "0";
            return;
        }

        document.getElementById('adm-count').innerText = list.length;

        list.forEach(u => {
            const row = document.createElement('div');
            row.className = 'admin-row';
            row.innerHTML = `
                <img src="${u.avatar_url}">
                <div class="admin-info">
                    <b>${u.first_name}</b> (@${u.username})<br>
                    <small style="color:#aaa">${u.gender}</small><br>
                    <span style="font-size:13px">${u.bio || "–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è"}</span>
                </div>
                <div class="admin-actions">
                    <button class="btn-approve" onclick="adminDecide('${u.username}', 'approve')">‚úÖ</button>
                    <button class="btn-reject" onclick="adminDecide('${u.username}', 'reject')">‚ùå</button>
                </div>
            `;
            cont.appendChild(row);
        });
    }

    async function adminDecide(username, action) {
        if(!confirm(`–¢–æ—á–Ω–æ ${action === 'approve' ? '–æ–¥–æ–±—Ä–∏—Ç—å' : '—É–¥–∞–ª–∏—Ç—å'} ${username}?`)) return;

        const res = await req("/admin/decision", "POST", {target_username: username, action: action});
        if(!res.error) {
            loadAdminList(); // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
        } else {
            alert("–û—à–∏–±–∫–∞: " + res.msg);
        }
    }

    // --- PUSH NOTIFICATIONS ---
    function requestNotifPermission() {
        if (!("Notification" in window)) return;
        Notification.requestPermission();
    }
    function startUnreadPoller() {
        if(UNREAD_INTERVAL) clearInterval(UNREAD_INTERVAL);
        pollUnread(); UNREAD_INTERVAL = setInterval(pollUnread, 3000);
    }
    async function pollUnread() {
        if(!ME || ME.username === 'admin') return; // –ê–¥–º–∏–Ω—É –ø—É—à–∏ –Ω–µ –Ω—É–∂–Ω—ã
        const res = await req(`/check_unread?email=${ME.email}`);
        const badge = document.getElementById('nav-msg-badge');
        if(res && res.count > 0) {
            badge.style.display = 'flex'; badge.innerText = res.count > 9 ? '9+' : res.count;
            if (res.latest && res.latest.id !== LAST_NOTIF_ID) {
                LAST_NOTIF_ID = res.latest.id;
                const chatIsOpen = (CHAT_USER && document.getElementById('chat-win').classList.contains('open'));
                if (!chatIsOpen && Notification.permission === "granted") {
                    new Notification(`–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${res.latest.sender}`, { body: res.latest.text });
                }
            }
        } else { badge.style.display = 'none'; }
    }

    // --- APP LOGIC ---
    function renderProfile() {
        document.getElementById('p_img').src = ME.avatar_url;
        document.getElementById('p_name').innerText = ME.first_name;
        document.getElementById('p_bio').innerText = ME.bio || "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è";
    }
    function openEdit() {
        document.getElementById('e_n').value = ME.first_name;
        document.getElementById('e_bio').value = ME.bio || "";
        document.getElementById('e_img').src = ME.avatar_url;
        EDIT_AVATAR_URL = ME.avatar_url;
        go('scr-edit');
    }
    async function saveProfile() {
        const res = await req("/update_profile", "PATCH", {
            username: ME.username, first_name: document.getElementById('e_n').value,
            bio: document.getElementById('e_bio').value, avatar_url: EDIT_AVATAR_URL
        });
        if(!res.error) { ME.first_name = res.first_name; ME.bio = res.bio; ME.avatar_url = res.avatar_url; go('scr-profile'); }
    }
    async function loadFeed() {
        if(FEED.length) return;
        const res = await req(`/feed?gender=${ME.gender}&my_username=${ME.username}`);
        FEED = res.error ? [] : res;
        nextCard();
    }
    function nextCard() {
        const area = document.getElementById('feed-area');
        if(!FEED.length) { area.innerHTML = "<br><center>–ü—É—Å—Ç–æ...</center>"; CURR=null; return; }
        CURR = FEED.pop();
        area.innerHTML = `<div class="feed-card"><img src="${CURR.avatar_url}"><div class="feed-info"><h2 style="margin-bottom:5px">${CURR.first_name}, @${CURR.username}</h2><p style="margin:0; opacity:0.8">${CURR.bio || ""}</p></div></div>`;
    }
    async function doLike() { if(!CURR) return; await req("/like", "POST", {from_email: ME.email, to_email: CURR.email}); nextCard(); }
    async function loadMatches() {
        const list = await req(`/matches?email=${ME.email}`);
        const grid = document.getElementById('matches-grid');
        grid.innerHTML = "";
        if(!list || !list.length) grid.innerHTML = "<p>–ù–µ—Ç –ø–∞—Ä</p>";
        else list.forEach(u => {
            const div = document.createElement('div');
            div.className = 'match-card';
            div.innerHTML = `<img src="${u.avatar_url}"><b>${u.first_name}</b><button class="match-btn" onclick='openChat(${JSON.stringify(u)})'>–ù–∞–ø–∏—Å–∞—Ç—å</button>`;
            grid.appendChild(div);
        });
    }
    async function loadChats() {
        const list = await req(`/chats_list?email=${ME.email}`);
        const cont = document.getElementById('chats-list');
        cont.innerHTML = "";
        if(list && !list.error) {
            list.forEach(u => {
                const b = u.unread_count > 0 ? `<div class="badge">${u.unread_count}</div>` : "";
                const div = document.createElement('div');
                div.className = 'chat-row';
                div.innerHTML = `<img src="${u.avatar_url}"> <div><b>${u.first_name}</b></div> ${b}`;
                div.onclick = () => openChat(u);
                cont.appendChild(div);
            });
        }
    }
    function openChat(user) {
        CHAT_USER = user;
        document.getElementById('c_title').innerText = user.first_name;
        document.getElementById('chat-win').classList.add('open');
        POLLING = true; pollChat();
    }
    function closeChat() {
        document.getElementById('chat-win').classList.remove('open');
        POLLING = false; CHAT_USER = null;
        go('scr-chats'); pollUnread();
    }
    async function pollChat() {
        if(!POLLING || !CHAT_USER) return;
        const msgs = await req(`/chat?u1=${ME.email}&u2=${CHAT_USER.email}`);
        const box = document.getElementById('c_box');
        if(msgs && !msgs.error && box.childElementCount !== msgs.length) {
            box.innerHTML = msgs.map(m => `<div class="msg ${m.sender_email === ME.email ? 'me' : 'him'}">${m.text}</div>`).join('');
            box.scrollTop = box.scrollHeight;
        }
        setTimeout(pollChat, 2000);
    }
    async function sendMsg() {
        const inp = document.getElementById('c_in');
        const txt = inp.value.trim();
        if(!txt) return; inp.value = "";
        document.getElementById('c_box').innerHTML += `<div class="msg me">${txt}</div>`;
        document.getElementById('c_box').scrollTop = 99999;
        await req("/message", "POST", {sender_email:ME.email, receiver_email:CHAT_USER.email, text:txt});
    }
</script>
</body>
</html>
